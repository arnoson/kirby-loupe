(function(){"use strict";const e=window.Vue;function k(){return window.panel}function x(){return k().api}e.computed,e.customRef,e.defineAsyncComponent,e.defineComponent,e.effectScope,e.getCurrentInstance,e.getCurrentScope,e.h,e.inject,e.isProxy,e.isReactive,e.isReadonly,e.isRef,e.isShallow,e.markRaw,e.nextTick,e.onActivated,e.onBeforeMount,e.onBeforeUnmount,e.onBeforeUpdate,e.onDeactivated,e.onErrorCaptured,e.onMounted,e.onRenderTracked,e.onRenderTriggered,e.onScopeDispose,e.onServerPrefetch,e.onUnmounted,e.onUpdated,e.provide,e.proxyRefs;const _=e.reactive;e.readonly,e.ref,e.shallowReactive,e.shallowReadonly,e.shallowRef,e.toRaw,e.toRef,e.toRefs,e.triggerRef,e.unref,e.useAttrs,e.useCssModule,e.useCssVars,e.useListeners,e.useSlots,e.watch,e.watchEffect,e.watchPostEffect,e.watchSyncEffect;const t=_({state:"idle",count:0,progress:0,error:null}),g=Vue.defineComponent({__name:"ReindexField",props:{chunk:{type:[Boolean,Number],default:!0}},setup(a){const o=a,s=x(),{t:n}=window.panel,p=Vue.computed(()=>t.state==="index"||t.state==="index-chunks"),c=r=>{t.state==="index-chunks"&&r.preventDefault()};Vue.onMounted(()=>{window.addEventListener("beforeunload",c),t.state!=="index-chunks"&&(t.state="idle")});const f=()=>{t.error=null,t.progress=0,o.chunk?i():d()},d=async()=>{t.state="index";try{const r=await s.get("plugin-kirby-loupe/reindex-all");t.count=r.count,t.state="success"}catch(r){t.error=r,t.state="error"}},i=async()=>{t.state="index-chunks",t.progress=1;const r=await s.get("/plugin-kirby-loupe/reindex-chunk/start");t.count=r.length;const l=typeof o.chunk=="number"?o.chunk:100,h=Math.ceil(r.length/l);for(let u=0;u<h;u++){const R=r.slice(u*l,(u+1)*l);try{await s.post("/plugin-kirby-loupe/reindex-chunk",{uuids:R})}catch(C){t.error=C;break}t.progress=1+u/(h-1)*99}t.state=t.error?"error":"success",window.removeEventListener("beforeunload",c)};return{__sfc:!0,props:o,api:s,t:n,isLoading:p,handleBeforeUnload:c,reindex:f,reindexAll:d,reindexChunked:i,store:t}}});function w(a,o,s,n,p,c,f,d){var i=typeof a=="function"?a.options:a;return o&&(i.render=o,i.staticRenderFns=s,i._compiled=!0),i._scopeId="data-v-"+c,{exports:a,options:i}}var m=function(){var o=this,s=o._self._c,n=o._self._setupProxy;return s("div",{staticClass:"loupe-reindex-field",attrs:{"data-state":n.store.state}},[s("k-button",{attrs:{variant:"filled",icon:n.isLoading?"loader":null,disabled:n.isLoading},on:{click:n.reindex}},[o._v(o._s(n.t("arnoson.kirby-loupe.reindex-site")))]),n.store.state==="index-chunks"?s("k-progress",{attrs:{value:n.store.progress}}):o._e(),n.store.state==="index-chunks"?s("k-box",{attrs:{theme:"info",text:n.t("arnoson.kirby-loupe.info-chunk-reindex")}}):o._e(),n.store.state==="success"?s("k-box",{attrs:{theme:"positive",text:`${n.t("arnoson.kirby-loupe.success",{count:n.store.count})}`}}):o._e(),n.store.state==="error"?s("k-box",{attrs:{theme:"negative",text:`${n.t("arnoson.kirby-loupe.error")}: ${n.store.error.message}`}}):o._e()],1)},v=[],y=w(g,m,v,!1,null,"3ceecd0b");const b=y.exports;window.panel.plugin("arnoson/kirby-loupe",{fields:{"loupe-reindex":b}})})();
